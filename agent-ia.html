<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant ISOTUILES</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(90deg, rgba(1, 46, 90, 1) 13%, rgba(1, 134, 196, 1) 86%);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 80vh;
            background: #fff;
            color: #000;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: #002F5C;
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .bot-message {
            color: #002F5C;
            font-weight: 500;
        }

        .user-message {
            text-align: right;
            color: #000;
        }

        .chat-input {
            display: flex;
            border-top: 1px solid #ccc;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: none;
            font-size: 1em;
        }

        .chat-input button {
            background: #002F5C;
            color: #fff;
            border: none;
            padding: 12px 18px;
            cursor: pointer;
        }

        .chat-input button:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <div class="chat-container">
        <div class="chat-header">Assistant ISOTUILES</div>
        <div class="chat-box" id="chat-box">
            <div class="message bot-message">Bonjour, je suis l’assistant ISOTUILES. Je peux vous renseigner sur nos
                panneaux imitation tuiles et vous aider à créer un devis sur mesure. Comment puis-je vous aider
                aujourd’hui ?</div>
        </div>
        <div class="chat-input">
            <input type="text" id="user-input" placeholder="Écrivez votre message...">
            <button id="send-btn">Envoyer</button>
        </div>
    </div>

    <script>

        // Fonction effet de frappe
        function typeText(element, text, speed = 25) {
            let i = 0;
            const interval = setInterval(() => {
                element.html(marked.parse(text.substring(0, i++)));
                if (i > text.length) clearInterval(interval);
            }, speed);
        }

        function appendMessage(content, sender = 'bot') {
            const msgClass = sender === 'user' ? 'user-message' : 'bot-message';
            const msgElement = $('<div>').addClass('message').addClass(msgClass);
            $('#chat-box').append(msgElement);

            if (sender === 'bot') {
                typeText(msgElement, content);
            } else {
                // Sécurisation des entrées utilisateur
                msgElement.text(content);
            }

            $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
        }

        async function sendToOpenAI(message) {
            const systemPrompt = `Tu es ISOTUILES, un assistant commercial professionnel spécialisé dans la vente de panneaux sandwich isolants imitation tuiles. Ton ton est avenant, clair et efficace. Tu poses les bonnes questions pour accompagner le client jusqu’à la génération d’un devis (dimensions, modèle, couleur, épaisseur, charpente, accessoires, coordonnées). Lorsque tu as toutes les informations, tu annonces que le devis peut être transmis à isotuiles@gmail.com.`;

            const response = await fetch("https://dev-isotuiles-p38jfxcbh-zialcoolos-projects.vercel.app/api/openai-proxy", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: message }
                    ]
                })
            });



            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        $('#send-btn').on('click', async function () {
            const userInput = $('#user-input').val().trim();
            if (!userInput) return;
            appendMessage(userInput, 'user');
            $('#user-input').val('');

            const botReply = await sendToOpenAI(userInput);
            appendMessage(botReply, 'bot');
        });

        $('#user-input').keypress(function (e) {
            if (e.which === 13) $('#send-btn').click();
        });
    </script>
</body>

</html>