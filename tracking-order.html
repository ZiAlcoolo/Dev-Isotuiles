<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Suivi de commande - Isotuiles</title>
    <script src="./modules/jquery.min.js"></script>

    <style>
        /* --- Reset & layout --- */
        :root {
            --primary: #1e88e5;
            --accent: #2b66a8;
            --muted: #6b7280;
            --bg: #f4f6f8;
            --card-bg: #ffffff;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius: 10px;
            --max-width: 980px;
            --gap: 18px;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: "Inter", Roboto, Arial, sans-serif;
            background: var(--bg);
            color: #111827;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.4;
        }

        .page {
            max-width: var(--max-width);
            margin: 28px auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .logo {
            width: 72px;
            height: 72px;
            background: rgba(255, 255, 255, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 700;
            letter-spacing: 0.6px;
        }

        .header h1 {
            margin: 0;
            font-size: 18px
        }

        .header .meta {
            opacity: 0.95;
            font-size: 14px
        }

        /* Main container */
        .grid {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: var(--gap);
            margin-top: 18px;
        }

        /* Card */
        .card {
            background: var(--card-bg);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
        }

        /* Timeline */
        .timeline {
            padding: 8px 0 0 0;
        }

        .progress-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }

        .step .dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin: 0 auto 8px;
            background: #e6eef9;
            border: 2px solid #d0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .step.done .dot {
            background: var(--success);
            border-color: rgba(22, 163, 74, 0.15)
        }

        .step.current .dot {
            background: var(--primary)
        }

        .step.pending .dot {
            background: #f1f5f9;
            border-color: #e6eef9;
            color: #94a3b8
        }

        .step .label {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px
        }

        .step .date {
            font-size: 12px;
            color: #374151
        }

        .progress-line {
            position: relative;
            height: 6px;
            background: #e6eef9;
            border-radius: 6px;
            margin-top: 18px;
            overflow: hidden;
        }

        .progress-fill {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width .6s cubic-bezier(.2, .9, .4, 1);
        }

        /* Right column */
        .summary h3 {
            margin: 0 0 8px 0
        }

        .summary .row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eef2f7
        }

        .summary .row:last-child {
            border-bottom: none
        }

        .summary .value {
            font-weight: 600
        }

        table.details {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px
        }

        table.details td {
            padding: 8px 6px;
            border-top: 1px solid #f3f6f9;
            font-size: 13px;
            color: #263238
        }

        table.details td.label {
            color: var(--muted);
            width: 38%
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 12px
        }

        .btn {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--primary);
            color: white
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #e6eef9;
            color: var(--accent)
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
            margin-top: 10px
        }

        @media (max-width:920px) {
            .grid {
                grid-template-columns: 1fr;
                padding-bottom: 20px
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px
            }

            .logo {
                width: 56px;
                height: 56px
            }
        }
    </style>
</head>

<body>

    <div class="page">
        <div class="header">
            <div class="logo">IS</div>
            <div>
                <h1>Suivi de votre commande</h1>
                <div class="meta">
                    Commande n° <strong id="orderId">—</strong> · <span id="clientName">—</span>
                </div>
            </div>
        </div>

        <div class="grid">
            <div>
                <div class="card">
                    <h3>Progression de la commande</h3>
                    <div class="timeline">
                        <div class="progress-bar" id="stepsContainer"></div>

                        <div class="progress-line">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>

                        <div class="muted" id="stageMsg"></div>
                    </div>

                    <h3 style="margin-top:20px">Détails de la commande</h3>
                    <table class="details">
                        <tr>
                            <td class="label">Modèle</td>
                            <td id="modele">—</td>
                        </tr>
                        <tr>
                            <td class="label">Épaisseur</td>
                            <td id="epaisseur">—</td>
                        </tr>
                        <tr>
                            <td class="label">Quantité</td>
                            <td id="quantite">—</td>
                        </tr>
                        <tr>
                            <td class="label">Longueurs (mm)</td>
                            <td id="longueurs">—</td>
                        </tr>
                        <tr>
                            <td class="label">Surface totale (m²)</td>
                            <td id="surface">—</td>
                        </tr>
                    </table>

                    <h3 style="margin-top:18px">Informations transport</h3>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                        <div style="flex:1">
                            <div class="muted">Statut transport</div>
                            <div id="transportStatus">—</div>
                        </div>
                    </div>
                </div>
            </div>

            <aside>
                <div class="card summary">
                    <h3>Récapitulatif</h3>

                    <div class="row">
                        <div>Client</div>
                        <div class="value" id="clientValue">—</div>
                    </div>
                    <div class="row">
                        <div>Montant devis (TTC)</div>
                        <div class="value" id="devisValue">—</div>
                    </div>
                    <div class="row">
                        <div>Acompte reçu</div>
                        <div class="value" id="acompteValue">—</div>
                    </div>
                    <div class="row">
                        <div>Solde payé</div>
                        <div class="value" id="soldeValue">—</div>
                    </div>
                    <div class="row">
                        <div>Reste dû</div>
                        <div class="value" id="resteValue">—</div>
                    </div>

                    <div style="margin-top:10px">
                        <div class="muted">Dernière mise à jour</div>
                        <div id="lastUpdate">—</div>
                    </div>

                    <div class="actions">
                        <a id="contactBtn" class="btn btn-outline" href="#">Contacter le service</a>
                        <a id="openLinkBtn" class="btn btn-primary" href="#" target="_blank">Voir le suivi complet</a>
                    </div>

                    <div class="muted" style="margin-top:12px">
                        Besoin d'aide ? contact@isotuiles.fr
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        async function chargerCommande() {
            const url = new URL(window.location.href);
            const token = url.searchParams.get("token");

            if (!token) {
                document.body.innerHTML = "<h2>Erreur : aucun token trouvé dans l’URL</h2>";
                return;
            }

            const response = await fetch(
                "https://script.google.com/macros/s/AKfycbzcsVGSWZGk0aAmjCOzkvRO_F9a5RHA9pYp9yvQbIxF4SAQfE0giTbT8ZhoQQSnHAo/exec?token=" + token
            );

            const data = await response.json();
            console.table(data)

            if (data.error) {
                document.body.innerHTML = "<h2>Erreur : " + data.error + "</h2>";
                return;
            }

            // Sauvegarde globale
            window.DATA = data;

            // Lance le rendu complet
            renderFromSheet(data);
        }

        chargerCommande();




        var order_data = null

        function renderFromSheet(data) {
            order_data = data;

            // -------------------------
            // MAP DES DONNÉES
            // -------------------------
            const d = {
                id_order: data["ID commande"],
                client: data["Nom client"],
                devis: Number(data["Montant devis"] || 0),
                acompte: Number(data["Acompte payé"] || 0),
                solde: Number(data["Solde payé"] || 0),

                modele: data["Modèle de panneau"] || "—",
                epaisseur: data["Épaisseur"] || "—",
                quantite: data["Quantité"] || "—",
                longueurs: data["Longueurs (mm)"] || "—",
                surface: data["Surface totale (m²)"] || "—",

                // Dates timeline
                etape: data["Étape actuelle"]|| "Commande enregistrée",

                trackingUrl: data["URL suivi client"] || "#"
            };

            // -------------------------
            // AFFICHAGE DES TEXTES
            // -------------------------
            $("#orderId").text(d.id_order);
            $("#clientName").text(d.client);

            $("#nom").text(d.client);
            $("#id").text(d.id_order);
            $("#etape").text(data["Étape actuelle"]);

            $("#clientValue").text(d.client);
            $("#devisValue").text(formatCurrency(d.devis));
            $("#acompteValue").text(formatCurrency(d.acompte));
            $("#soldeValue").text(formatCurrency(d.solde));
            $("#resteValue").text(formatCurrency(d.devis - d.acompte - d.solde));

            $("#modele").text(d.modele);
            $("#epaisseur").text(d.epaisseur);
            $("#quantite").text(d.quantite);
            $("#longueurs").text(d.longueurs);
            $("#surface").text(d.surface);

            const now = new Date();

            const formatted_today_date = now.toLocaleString("fr-FR", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit"
            }).replace(',', ' -');


            $("#lastUpdate").text(formatted_today_date);

            $("#openLinkBtn").attr("href", d.trackingUrl);
            
            // -------------------------
            // TIMELINE
            // -------------------------
            const currentStep = d.etape;
            console.log(currentStep)
            $("#transportStatus").text(d.currentStep === "En cours de livraison"||d.currentStep === "Livré" ? "Expédié" : "Non expédié");

            const ORDER_STEPS = [
                "Commande enregistrée",
                "Production",
                "Prêt à être expédié",
                "En cours de livraison",
                "Livré",
            ];

            const STEPS = ORDER_STEPS.map(step => ({
                label: step,
                isCurrent: (step === currentStep),
                isDone: (ORDER_STEPS.indexOf(step) < ORDER_STEPS.indexOf(currentStep)),
                date: d[step] || ""  // tu peux brancher les dates plus tard si tu veux
            }));

            renderTimeline(STEPS);

        }

        // -----------------------------------------------------------
        // TIMELINE dynamique en jQuery
        // -----------------------------------------------------------

        function renderTimeline(steps) {

    const $stepsContainer = $("#stepsContainer");
    const $progressFill = $("#progressFill");
    const $stageMsg = $("#stageMsg");

    $stepsContainer.empty();

    const completed = steps.filter(s => s.isDone).length;
    const pct = Math.round((completed / steps.length) * 100);

    steps.forEach((s, idx) => {

        const className = s.isDone 
            ? "done" 
            : s.isCurrent 
            ? "current" 
            : "pending";

        const html = `
        <div class="step ${className}">
            <div class="dot">${s.isDone ? "✓" : s.isCurrent ? idx + 1 : ""}</div>
            <div class="label">${s.label}</div>
            <div class="date">${s.date ? formatDate(s.date) : ""}</div>
        </div>`;

        $stepsContainer.append(html);
    });

    $progressFill.css("width", pct + "%");
    $stageMsg.text(getStageMessage(pct));
}


        // -------- Utils ----------
        function formatCurrency(x) {
            return Number(x).toLocaleString("fr-FR", {
                style: "currency",
                currency: "EUR"
            });
        }

        function formatDate(v) {
            if (!v) return "";
            const d = new Date(v);
            if (isNaN(d.getTime())) return "";
            return d.toLocaleDateString("fr-FR", {
                year: "numeric",
                month: "short",
                day: "numeric"
            });
        }

        function getStageMessage(pct) {
            if (pct === 100) return "Votre commande a été finalisée et livrée — merci !";
            if (pct >= 60) return "Votre commande est en cours d'expédition ou proche de la livraison.";
            if (pct >= 30) return "Votre commande est en production.";
            return "Votre commande est en cours de traitement.";
        }

    </script>

    <!-- ID DEPLOY :
 AKfycbzcsVGSWZGk0aAmjCOzkvRO_F9a5RHA9pYp9yvQbIxF4SAQfE0giTbT8ZhoQQSnHAo
  -->
    <!-- WEB APP URL :
  https://script.google.com/macros/s/AKfycbzcsVGSWZGk0aAmjCOzkvRO_F9a5RHA9pYp9yvQbIxF4SAQfE0giTbT8ZhoQQSnHAo/exec
   -->
</body>

</html>