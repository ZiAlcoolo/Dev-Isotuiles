<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Suivi de commande - Isotuiles</title>
    <script src="./modules/jquery.min.js"></script>

    <link rel="stylesheet" href="./styles/tracking-order.css">
</head>

<body>

    <!-- <div id="popup" style="display: none;">
        <div class="popup-content">
            <img class="close" onclick="$('#popup').hide()" width="20" height="20"
                src="https://img.icons8.com/ios/50/delete-sign--v1.png" alt="close popup" />
            <h3>Titre popup</h3>
            <p class="muted" style="margin-top:12px">
                Votre commande est en cours d'expédition ou proche de la livraison.
            </p>

        </div>
    </div> -->

    <div class="page">
        <div class="header">
            <div class="logo" onclick="window.open('https://isotuiles.fr/', '_blank')">
                <img src="./media/logo-white.webp" alt="Logo Isotuiles">
            </div>

            <div style="flex: 1;">
                <h1>Suivi de votre commande</h1>
                <div class="meta">
                    Commande n° <strong id="orderId">—</strong> · <span id="clientName">—</span>
                </div>
            </div>
            <div id="data_synch" style="margin-top:10px">
                <div class="muted">Dernière mise à jour</div>
                <div id="lastUpdate">—</div>
            </div>
        </div>

        <div class="grid">
            <div>
                <div class="card">
                    <h3>Progression de la commande</h3>
                    <div class="muted"></div>

                    <div id="progress-container">
                        <p>Chargement des informations en cours</p>
                    </div>

                    <h3>Informations transport</h3>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:stretch">
                        <div style="flex:1">
                            <div class="muted">Delai Livraison</div>
                            <div id="delaiLivraisonStatus">—</div>
                        </div>
                        <div style="flex:1">
                            <div class="muted">Statut transport</div>
                            <div id="transportStatus">—</div>
                        </div>
                    </div>
                </div>
            </div>

            <aside>
                <div class="card summary">
                    <h3>Détails de la commande</h3>
                    <table class="details">
                        <tr>
                            <td class="label">Modèle</td>
                            <td id="modele">—</td>
                        </tr>
                        <tr>
                            <td class="label">Épaisseur</td>
                            <td id="epaisseur">—</td>
                        </tr>
                        <tr>
                            <td class="label">Quantité</td>
                            <td id="quantite">—</td>
                        </tr>
                        <tr>
                            <td class="label">Longueurs (mm)</td>
                            <td id="longueurs">—</td>
                        </tr>
                        <tr>
                            <td class="label">Surface totale (m²)</td>
                            <td id="surface">—</td>
                        </tr>
                    </table>

                    <h3 style="margin-top:20px">Récapitulatif</h3>

                    <div class="row">
                        <div>Client</div>
                        <div class="value" id="clientValue">—</div>
                    </div>
                    <div class="row">
                        <div>Montant devis (TTC)</div>
                        <div class="value" id="devisValue">—</div>
                    </div>
                    <div class="row">
                        <div>Acompte payé</div>
                        <div class="value" id="acompteValue">—</div>
                    </div>
                    <div class="row">
                        <div>Reste dû</div>
                        <div class="value" id="resteValue">—</div>
                    </div>

                    <div class="actions">
                        <a id="contactBtn" class="btn btn-outline" href="https://isotuiles.fr/pages/conctactez-nous"
                            target="_blank">Contacter le service</a>
                    </div>

                    <div class="muted" style="margin-top:12px">
                        Besoin d'aide ? <a style="color:grey"
                            href="mailto:service.client.isotuiles@gmail.com">service.client.isotuiles@gmail.com</a>
                    </div>
                </div>
            </aside>
        </div>

        <div id="faq_commande" class="card">
            <h3>FAQ commande</h3>
            <div id="faq-container"></div>

        </div>
    </div>

    <script src="./scripts/faq-ui.js"></script>


    <script>
        async function chargerCommande() {
            const url = new URL(window.location.href);
            const token = url.searchParams.get("token");

            if (!token) {
                document.body.innerHTML = "<h2>Erreur : aucun token trouvé dans l’URL</h2>";
                return;
            }

            const response = await fetch(
                "https://script.google.com/macros/s/AKfycbzcsVGSWZGk0aAmjCOzkvRO_F9a5RHA9pYp9yvQbIxF4SAQfE0giTbT8ZhoQQSnHAo/exec?token=" + token
            );

            const data = await response.json();
            console.table(data)

            if (data.error) {
                document.body.innerHTML = "<h2>Erreur : " + data.error + "</h2>";
                return;
            }

            // Sauvegarde globale
            window.DATA = data;

            // Lance le rendu complet
            renderFromSheet(data);
        }

        chargerCommande();




        var order_data = null

        function renderFromSheet(data) {
            order_data = data;

            // -------------------------
            // MAP DES DONNÉES
            // -------------------------
            const d = {
                id_order: data["ID commande"],
                client: data["Nom client"],
                devis: Number(data["Montant devis"] || 0),
                acompte: Number(data["Acompte payé"] || 0),

                modele: data["Modèle de panneau"] || "—",
                epaisseur: data["Épaisseur"] || "—",
                quantite: data["Quantité"] || "—",
                longueurs: data["Longueurs (mm)"] || "—",
                surface: data["Surface totale (m²)"] || "—",

                // Dates timeline
                etape: data["Étape actuelle"] || "Commande enregistrée",
                dates_etapes: [data["Date Commande enregistrée"], data["Date Production"], data["Date Prêt à être expédié"], data["Date En cours de livraison"], data["Date Livré"]],

                delai_livraison: data["Délai Livraison"],

                trackingUrl: data["URL suivi client"] || "#",
            };

            // -------------------------
            // AFFICHAGE DES TEXTES
            // -------------------------
            $("#orderId").text(d.id_order);
            $("#clientName").text(d.client);

            $("#nom").text(d.client);
            $("#id").text(d.id_order);
            $("#etape").text(data["Étape actuelle"]);

            $("#clientValue").text(d.client);
            $("#devisValue").text(formatCurrency(d.devis));
            $("#acompteValue").text(formatCurrency(d.acompte));
            $("#resteValue").text(formatCurrency(d.devis - d.acompte));

            $("#modele").text(d.modele);
            $("#epaisseur").text(d.epaisseur);
            $("#quantite").text(d.quantite);
            $("#longueurs").text(d.longueurs);
            $("#surface").text(d.surface);





            const formatted_today_date = FormattedDate(new Date());


            $("#lastUpdate").text(formatted_today_date);

            $("#openLinkBtn").attr("href", d.trackingUrl);

            // -------------------------
            // TIMELINE
            // -------------------------
            const currentStep = d.etape;
            $("#transportStatus").text(d.currentStep === "En cours de livraison" || d.currentStep === "Livré" ? "Expédié" : "Non expédié");
            if (d.delai_livraison) {
                $("#delaiLivraisonStatus").html(`<b>${d.delai_livraison}</b>`);
            }

            const ORDER_STEPS = [
                "Commande enregistrée",
                "Production",
                "Prêt à être expédié",
                "En cours de livraison",
                "Livré",
            ];
            const STEPS_DESCRIPTION = [
                "Nos équipes ont bien reçu votre commande et vérifient les informations fournies.",
                "Votre commande est en cours de fabrication selon les dimensions et coloris choisis.",
                "Votre commande est emballée et en attente de prise en charge par le transporteur.",
                "Votre commande est en transit et acheminée vers votre adresse de livraison.",
                "Votre commande a été remise avec succès. Contactez-nous en cas de besoin.",
            ];

            GenerateDetailedSteps(d.dates_etapes, currentStep, ORDER_STEPS, STEPS_DESCRIPTION)

        }


        // Nouvel affichage
        function GenerateDetailedSteps(dates, current_step, steps, descriptions) {
            let html = "";
            var circle_style = ""

            steps.forEach((step, i) => {
                const date = dates && dates[i] ? `<span> - ${FormattedDate(new Date(dates[i]))}</span>` : "";

                circle_style = step === current_step ? "present" : circle_style === "present" ? "future" : circle_style === "future" ? "future" : "past";

                html += `
        <div class="step-container${" " + circle_style}">
            <div class="dots-container">
                <div class="circle-1">
                    <div class="circle-2"></div>
                </div>
            </div>
            <div class="text-content">
                <h4>${step}${date}</h4>
                <p>${descriptions[i]}</p>
            </div>
        </div>
        <div class="progession-bar${" " + circle_style}"><div><div class="inner-bar"></div></div></div>
        `;
            });

            return $("#progress-container").html(html);
        }



        // -------- Utils ----------
        function formatCurrency(x) {
            return Number(x).toLocaleString("fr-FR", {
                style: "currency",
                currency: "EUR"
            });
        }

        function formatDate(v) {
            if (!v) return "";
            const d = new Date(v);
            if (isNaN(d.getTime())) return "";
            return d.toLocaleDateString("fr-FR", {
                year: "numeric",
                month: "short",
                day: "numeric"
            });
        }

        function getStageMessage(pct) {
            if (pct === 100) return "Votre commande a été finalisée et livrée — merci !";
            if (pct >= 60) return "Votre commande est en cours d'expédition ou proche de la livraison.";
            if (pct >= 30) return "Votre commande est en production.";
            return "Votre commande est en cours de traitement.";
        }


        function FormattedDate(date, f) {
            var date_formatted = "--"
            if (f) {
                date_formatted = date.toLocaleString("fr-FR", {
                    day: "2-digit",
                    month: "2-digit",
                    year: "2-digit",
                }).replace(',', ' -')
            } else {
                date_formatted = date.toLocaleString("fr-FR", {
                    day: "2-digit",
                    month: "2-digit",
                    year: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit"
                }).replace(',', ' -')
            }
            return date_formatted
        }

    </script>

    <!-- ID DEPLOY :
 AKfycbzcsVGSWZGk0aAmjCOzkvRO_F9a5RHA9pYp9yvQbIxF4SAQfE0giTbT8ZhoQQSnHAo
  -->
    <!-- WEB APP URL :
  https://script.google.com/macros/s/AKfycbzcsVGSWZGk0aAmjCOzkvRO_F9a5RHA9pYp9yvQbIxF4SAQfE0giTbT8ZhoQQSnHAo/exec
   -->
</body>

</html>